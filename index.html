<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BRIDGE HUD</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: #000;
      color: #ff1a1a;
      font-family: 'Press Start 2P', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    h1 {
      margin-bottom: 30px;
      font-size: 3rem;
      color: #ff0000;
      text-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000, 0 0 20px #880000;
    }
    .container {
      width: 90%;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      gap: 30px;
    }
    .ais-section, .radar-section, .moon-section, .weather-section {
      border: 2px solid #ff1a1a;
      padding: 20px;
      background: rgba(255,0,0,0.05);
      position: relative;
    }
    .ais-section {
      height: 400px;
      overflow-y: auto;
    }
    .ais-item {
      padding: 8px 0;
      border-bottom: 1px dashed #ff1a1a;
      font-size: 1rem;
    }
    .radar-section {
      height: 300px;
    }
    .radar-widget {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #111;
      color: #ff1a1a;
      font-size: 1.2rem;
    }
    .bottom-row {
      display: flex;
      gap: 20px;
    }
    .moon-section, .weather-section {
      flex: 1;
      height: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }
    .moon-phase {
      font-size: 4rem;
    }
  </style>
</head>
<body>
  <h1>BRIDGE HUD</h1>
  <div class="container">
    <div class="ais-section" id="ais-section">
      <div class="ais-item">Loading AIS dataâ€¦</div>
    </div>
    <div class="radar-section" id="radar-section">
      <div class="radar-widget" id="radar-widget">Loading Radarâ€¦</div>
    </div>
    <div class="bottom-row">
      <div class="moon-section" id="moon-section">
        <div class="moon-phase" id="moon-phase">ðŸŒ‘</div>
        <div id="moon-info">Moon Phase: Loadingâ€¦</div>
      </div>
      <div class="weather-section" id="weather-section">
        <div id="weather-info">Loading Weatherâ€¦</div>
      </div>
    </div>
  </div>

  <script>
    // ========== Config ==========
    const METEOSOURCE_API_KEY = 'YOUR_METEOSOURCE_API_KEY';
    const LAT = 41.8781;
    const LON = -87.6298;

    // ========== AIS ==========

    async function fetchAISReal() {
      // Replace this with logic calling a real AIS API.
      // For example, you might do:
      // const url = `https://api.yourAISprovider.com/vessels?lat=${LAT}&lon=${LON}&radius=...&apikey=...`
      // const resp = await fetch(url);
      // return resp.json();
      // For now return mock data:
      return [
        { name: "MV Chicago", lat: 41.82, lon: -87.57, status: "Underway" },
        { name: "Tug Enterprise", lat: 41.70, lon: -87.59, status: "Moored" },
        { name: "Cargo Vessel 3", lat: 41.65, lon: -87.55, status: "Anchored" }
      ];
    }

    async function updateAIS() {
      const container = document.getElementById('ais-section');
      try {
        const vessels = await fetchAISReal();
        container.innerHTML = '';
        vessels.forEach(v => {
          const div = document.createElement('div');
          div.className = 'ais-item';
          div.textContent = `${v.name} â€” Lat: ${v.lat.toFixed(4)}, Lon: ${v.lon.toFixed(4)} â€” ${v.status}`;
          container.appendChild(div);
        });
      } catch (e) {
        container.innerHTML = '<div class="ais-item">Error loading AIS data.</div>';
      }
    }

    // ========== Weather & Moon via Meteosource ==========

    async function fetchWeatherData() {
      const url = `https://api.meteosource.com/v1/forecast?place_id=chicago&sections=current,astronomy&language=en&units=us&apikey=${METEOSOURCE_API_KEY}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Weather fetch error');
      return resp.json();
    }

    function moonFromAstronomy(astro) {
      // Depending on API's astronomy section, parse moon phase.
      // Meteosource returns something like moon_phase name / percent etc
      if (!astro) return null;
      return {
        name: astro.moon_phase ?? 'Unknown',
        illumination: astro.moon_illumination ?? null
      };
    }

    async function updateWeatherAndMoon() {
      const weatherSection = document.getElementById('weather-section');
      const moonInfo = document.getElementById('moon-info');
      const moonPhaseElem = document.getElementById('moon-phase');

      try {
        const data = await fetchWeatherData();
        // Current weather
        const cur = data.current;
        weatherSection.innerHTML = `
          <div><strong>Chicago</strong></div>
          <div>Temp: ${cur.temperature}Â°F</div>
          <div>Feels like: ${cur.feels_like}Â°F</div>
          <div>Condition: ${cur.weather}</div>
          <div>Humidity: ${cur.humidity}%</div>
          <div>Wind: ${cur.wind_speed} mph</div>
        `;
        // Moon
        const astro = data.astronomy;
        const moon = moonFromAstronomy(astro);
        if (moon) {
          moonPhaseElem.textContent = astro.moon_phase_emoji || moon.name.charAt(0);
          moonInfo.textContent = `Moon: ${moon.name}` + (moon.illumination != null ? ` (${(moon.illumination*100).toFixed(1)}%)` : '');
        } else {
          moonInfo.textContent = 'Moon data unavailable';
        }
      } catch (e) {
        weatherSection.innerHTML = 'Error loading weather.';
        moonInfo.textContent = 'Error loading moon data.';
        console.error(e);
      }
    }

    // ========== Radar ==========

    async function updateRadar() {
      const radarWidget = document.getElementById('radar-widget');
      // You need a URL to radar imagery. Possible source: NOAA / NWS local radar image tile or large PNG.
      // Example placeholder:
      const radarImageUrl = 'https://via.placeholder.com/800x300.png?text=Radar+Image';
      const img = new Image();
      img.src = radarImageUrl;
      img.style.maxWidth = '100%';
      img.style.maxHeight = '100%';
      img.onload = () => {
        radarWidget.innerHTML = '';
        radarWidget.appendChild(img);
      };
      img.onerror = () => {
        radarWidget.textContent = 'Radar image error';
      };
    }

    // ========== Moon fallback algorithm (if API doesnâ€™t provide) ==========

    function getMoonPhaseLocal(date) {
      const lp = 2551443;
      const newMoon = new Date('2001-01-01T00:00:00Z').getTime()/1000;
      const now = date.getTime()/1000;
      const phase = ((now - newMoon) % lp) / lp;
      const index = Math.floor(phase * 8 + 0.5) % 8;
      const phases = ['New Moon','Waxing Crescent','First Quarter','Waxing Gibbous','Full Moon','Waning Gibbous','Last Quarter','Waning Crescent'];
      const emojis = ['ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜'];
      return { phase: phases[index], emoji: emojis[index] };
    }

    function updateMoonLocal() {
      const moonPhaseElem = document.getElementById('moon-phase');
      const moonInfo = document.getElementById('moon-info');
      const m = getMoonPhaseLocal(new Date());
      moonPhaseElem.textContent = m.emoji;
      moonInfo.textContent = `Moon Phase: ${m.phase}`;
    }

    // ========== Initialize & Intervals ==========

    document.addEventListener('DOMContentLoaded', () => {
      updateAIS();
      updateWeatherAndMoon();
      updateRadar();
      
      // refresh
      setInterval(updateAIS, 60000);          // every minute
      setInterval(updateWeatherAndMoon, 300000);  // every 5 min
      setInterval(updateRadar, 300000);         // every 5 min
      // If using fallback moon local:
      // setInterval(updateMoonLocal, 86400000);
    });
  </script>
</body>
</html>
